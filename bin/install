#!/usr/bin/env bash
# OS X development initialization script.
# Author Ron. A @0xADADA


# Install homebrew is installed.development machine local dependencies
if ! [ -x /usr/local/bin/brew ]; then
    echo "homebrew must be installed. Please install and try this again."
    echo "brew is typically installed with the following command:"
    echo "$ ruby -e \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\""
    echo "Opening homebrew website..."
    open "http://brew.sh/"
    exit 1
fi
if ! hash boot2docker 2>/dev/null; then
    echo "Installing boot2docker..."
    brew install boot2docker
    # Start boot2docker via launchd at login
    ln -sfv /usr/local/opt/boot2docker/*.plist ~/Library/LaunchAgents
fi
if ! hash docker-compose 2>/dev/null; then
    echo "Installing docker-compose..."
    brew install docker-compose
fi
if ! hash eb 2>/dev/null; then
    echo "Installing Amazon Elastic Beanstalk CLI..."
    brew install aws-elasticbeanstalk
fi

# Create Docker VM if it doesn't exist
boot2docker status
if [[ $? != 0 ]]; then
    echo "Creating Docker host virtual machine..."
    boot2docker init
    echo "Docker host virtual machine created."
else
    echo "Docker host virtual machine found."
fi

# Start Docker VM if it is not running.
if [ -z "$(boot2docker status | grep running)" ]; then
    echo "Docker host virtual machine not running, booting now..."
    boot2docker start
    echo "Docker host virtual machine is running."
else
    echo "Docker host virtual machine is running."
fi

# Set the Docker environment variables in your shell
echo "Your system is setup."
echo "To run a development environment, try running:"
echo "$ ./bin/stevedore dev start"
